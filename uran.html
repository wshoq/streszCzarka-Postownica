<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>☢️ Market Dashboard</title>
<style>
body { font-family: Arial; max-width: 900px; margin: auto; padding: 2rem; background: #f7f7f7; }
h1, h2 { text-align: center; }
.panel { display: flex; justify-content: space-around; margin-bottom: 2rem; background: #fff; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
table { width: 100%; border-collapse: collapse; background: #fff; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
th, td { padding: 0.5rem; border-bottom: 1px solid #ddd; text-align: left; }
th { background-color: #007bff; color: white; }
</style>
</head>
<body>
<h1>☢️ Market Dashboard</h1>

<div class="panel" id="market-panel">
  <div>Ładowanie danych rynkowych...</div>
</div>

<h2>Surowce i Indeksy</h2>
<table>
  <thead>
    <tr>
      <th>Nazwa</th>
      <th>Cena</th>
      <th>Daily</th>
      <th>Daily %</th>
      <th>Weekly %</th>
      <th>Monthly %</th>
      <th>YTD %</th>
      <th>YoY %</th>
      <th>Date</th>
    </tr>
  </thead>
  <tbody id="dashboard-table">
    <tr><td colspan="9">Ładowanie danych...</td></tr>
  </tbody>
</table>

<script>
const SUPABASE_URL = "https://uybpjjqvtcpsxihpbhlp.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV5YnBqanF2dGNwc3hpaHBiaGxwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA0MzMxOTksImV4cCI6MjA2NjAwOTE5OX0.t2amEymFNyEr7bEZ4_p5qX5zxdpx60m3vlyyj2uZkdc";

const marketPanel = document.getElementById('market-panel');
const dashboardTable = document.getElementById('dashboard-table');

async function fetchMarketPanel() {
  try {
    const res = await fetch('https://markety-qiy7.onrender.com/api/markets');
    const data = await res.json();

    marketPanel.innerHTML = '';
    for (const [name, info] of Object.entries(data)) {
      marketPanel.innerHTML += `
        <div>
          <strong>${name}</strong><br/>
          ${info.price !== null ? info.price : '—'}
        </div>
      `;
    }
  } catch (err) {
    console.error(err);
    marketPanel.innerHTML = '<div>Błąd podczas ładowania danych rynkowych.</div>';
  }
}

async function fetchDashboard() {
  try {
    const res = await fetch(`${SUPABASE_URL}/rest/v1/dashboard?select=title,content&order=id.asc&limit=100`, {
      headers: {
        apikey: SUPABASE_KEY,
        Authorization: `Bearer ${SUPABASE_KEY}`,
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      }
    });
    const items = await res.json();

    if (!items.length) {
      dashboardTable.innerHTML = '<tr><td colspan="9">Brak danych.</td></tr>';
      return;
    }

    dashboardTable.innerHTML = '';
    items.forEach(item => {
      let price='—', daily='—', dailyPct='—', weekly='—', monthly='—', ytd='—', yoy='—', date='—';

      // Surowce: dopasowanie Price, Daily, Daily %, Weekly %, Monthly %, YTD %, YoY %, Date
      const priceMatch = item.content.match(/Price:\s*([\d.]+)/);
      const dailyMatch = item.content.match(/Daily:\s*([\d.-]+)/);
      const dailyPctMatch = item.content.match(/Change:\s*([\d.-]+)%/);
      const weeklyMatch = item.content.match(/Weekly:\s*([\d.-]+)%/);
      const monthlyMatch = item.content.match(/Monthly:\s*([\d.-]+)%/);
      const ytdMatch = item.content.match(/YTD:\s*([\d.-]+)%/);
      const yoyMatch = item.content.match(/YoY:\s*([\d.-]+)%/);
      const dateMatch = item.content.match(/Date:\s*([\w\/]+)/);

      if (priceMatch) price = priceMatch[1];
      if (dailyMatch) daily = dailyMatch[1];
      if (dailyPctMatch) dailyPct = dailyPctMatch[1] + '%';
      if (weeklyMatch) weekly = weeklyMatch[1] + '%';
      if (monthlyMatch) monthly = monthlyMatch[1] + '%';
      if (ytdMatch) ytd = ytdMatch[1] + '%';
      if (yoyMatch) yoy = yoyMatch[1] + '%';
      if (dateMatch) date = dateMatch[1];

      dashboardTable.innerHTML += `
        <tr>
          <td>${item.title}</td>
          <td>${price}</td>
          <td>${daily}</td>
          <td>${dailyPct}</td>
          <td>${weekly}</td>
          <td>${monthly}</td>
          <td>${ytd}</td>
          <td>${yoy}</td>
          <td>${date}</td>
        </tr>
      `;
    });
  } catch (err) {
    console.error(err);
    dashboardTable.innerHTML = '<tr><td colspan="9">Błąd podczas ładowania danych.</td></tr>';
  }
}

fetchMarketPanel();
fetchDashboard();
</script>
</body>
</html>
