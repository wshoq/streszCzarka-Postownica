<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>☢️ Market Dashboard</title>
<style>
body { font-family: Arial; max-width: 1200px; margin: auto; padding: 2rem; background: #f7f7f7; }
h1, h2 { text-align: center; }
.container { display: flex; justify-content: space-between; margin-bottom: 2rem; gap: 1rem; }
.panel { flex: 1; background: #fff; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
table { width: 100%; border-collapse: collapse; background: #fff; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 6px rgba(0,0,0,0.1); margin-bottom: 2rem; }
th, td { padding: 0.5rem; border-bottom: 1px solid #ddd; text-align: left; }
th { background-color: #007bff; color: white; }
.positive { color: green; font-weight: bold; }
.negative { color: red; font-weight: bold; }
</style>
</head>
<body>
<h1>☢️ Market Dashboard</h1>

<div class="container">
  <div class="panel" id="indices-panel">
    <h2>Indeksy</h2>
    <table>
      <thead>
        <tr><th>Nazwa</th><th>Cena</th><th>Zmiana %</th></tr>
      </thead>
      <tbody id="indices-table">
        <tr><td colspan="3">Ładowanie...</td></tr>
      </tbody>
    </table>
  </div>

  <div class="panel" id="markets-panel">
    <h2>Waluty / BTC / 10Y Bond</h2>
    <table>
      <thead>
        <tr><th>Nazwa</th><th>Cena</th></tr>
      </thead>
      <tbody id="markets-table">
        <tr><td colspan="2">Ładowanie...</td></tr>
      </tbody>
    </table>
  </div>
</div>

<h2>Surowce</h2>
<table>
  <thead>
    <tr>
      <th>Nazwa</th>
      <th>Cena</th>
      <th>Daily</th>
      <th>Daily %</th>
      <th>Weekly %</th>
      <th>Monthly %</th>
      <th>YTD %</th>
      <th>YoY %</th>
      <th>Date</th>
    </tr>
  </thead>
  <tbody id="commodities-table">
    <tr><td colspan="9">Ładowanie danych...</td></tr>
  </tbody>
</table>

<script>
const SUPABASE_URL = "https://uybpjjqvtcpsxihpbhlp.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV5YnBqanF2dGNwc3hpaHBiaGxwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA0MzMxOTksImV4cCI6MjA2NjAwOTE5OX0.t2amEymFNyEr7bEZ4_p5qX5zxdpx60m3vlyyj2uZkdc";

const indicesTable = document.getElementById('indices-table');
const marketsTable = document.getElementById('markets-table');
const commoditiesTable = document.getElementById('commodities-table');

// -------------------- PANEL WALUT / BTC / BOND --------------------
async function fetchMarketsPanel() {
  try {
    const res = await fetch('https://markety-qiy7.onrender.com/api/markets');
    const data = await res.json();
    marketsTable.innerHTML = '';
    for (const [name, info] of Object.entries(data)) {
      marketsTable.innerHTML += `<tr><td>${name}</td><td>${info.price !== null ? info.price : '—'}</td></tr>`;
    }
  } catch (err) {
    console.error(err);
    marketsTable.innerHTML = '<tr><td colspan="2">Błąd ładowania danych.</td></tr>';
  }
}

// -------------------- PANEL INDEKSÓW --------------------
async function fetchIndicesPanel() {
  try {
    const res = await fetch(`${SUPABASE_URL}/rest/v1/dashboard?select=title,content&order=id.asc&limit=100`, {
      headers: {
        apikey: SUPABASE_KEY,
        Authorization: `Bearer ${SUPABASE_KEY}`,
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      }
    });
    const items = await res.json();

    indicesTable.innerHTML = '';
    items.forEach(item => {
      if (item.content.includes('pkt')) { // indeksy
        const priceMatch = item.content.match(/:\s*([\d.,]+)\s*pkt/);
        const changeMatch = item.content.match(/\(([-\d.,]+)%\)/);
        const price = priceMatch ? priceMatch[1] : '—';
        const change = changeMatch ? changeMatch[1] : '—';
        const changeClass = parseFloat(change) > 0 ? 'positive' : (parseFloat(change) < 0 ? 'negative' : '');
        indicesTable.innerHTML += `<tr><td>${item.title}</td><td>${price}</td><td class="${changeClass}">${change !== '—' ? change+'%' : '—'}</td></tr>`;
      }
    });

  } catch (err) {
    console.error(err);
    indicesTable.innerHTML = '<tr><td colspan="3">Błąd ładowania indeksów.</td></tr>';
  }
}

// -------------------- TABELA SUROWCÓW --------------------
async function fetchCommodities() {
  try {
    const res = await fetch(`${SUPABASE_URL}/rest/v1/dashboard?select=title,content&order=id.asc&limit=100`, {
      headers: {
        apikey: SUPABASE_KEY,
        Authorization: `Bearer ${SUPABASE_KEY}`,
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      }
    });
    const items = await res.json();

    commoditiesTable.innerHTML = '';
    items.forEach(item => {
      if (item.content.includes('Price:')) { // surowce
        const price = (item.content.match(/Price:\s*([\d.]+)/) || [])[1] || '—';
        const daily = (item.content.match(/Daily:\s*([\d.-]+)/) || [])[1] || '—';
        const dailyPct = (item.content.match(/Change:\s*([\d.-]+)%/) || [])[1] || '—';
        const weekly = (item.content.match(/Weekly:\s*([\d.-]+)%/) || [])[1] || '—';
        const monthly = (item.content.match(/Monthly:\s*([\d.-]+)%/) || [])[1] || '—';
        const ytd = (item.content.match(/YTD:\s*([\d.-]+)%/) || [])[1] || '—';
        const yoy = (item.content.match(/YoY:\s*([\d.-]+)%/) || [])[1] || '—';
        const dateRaw = (item.content.match(/Date:\s*([\w\/]+)/) || [])[1] || '';
        let dateNum = '—';
        if(dateRaw){
          const [monthStr, yearStr] = dateRaw.split('/');
          const months = {Jan:1,Feb:2,Mar:3,Apr:4,May:5,Jun:6,Jul:7,Aug:8,Sep:9,Oct:10,Nov:11,Dec:12};
          if(monthStr && yearStr && months[monthStr]){
            dateNum = `${2000+parseInt(yearStr)}-${String(months[monthStr]).padStart(2,'0')}-01`;
          }
        }
        const dailyClass = parseFloat(dailyPct) > 0 ? 'positive' : (parseFloat(dailyPct) < 0 ? 'negative' : '');
        commoditiesTable.innerHTML += `
          <tr>
            <td>${item.title}</td>
            <td>${price}</td>
            <td>${daily}</td>
            <td class="${dailyClass}">${dailyPct}%</td>
            <td>${weekly}%</td>
            <td>${monthly}%</td>
            <td>${ytd}%</td>
            <td>${yoy}%</td>
            <td>${dateNum}</td>
          </tr>
        `;
      }
    });
  } catch (err) {
    console.error(err);
    commoditiesTable.innerHTML = '<tr><td colspan="9">Błąd ładowania danych.</td></tr>';
  }
}

// -------------------- INIT --------------------
fetchMarketsPanel();
fetchIndicesPanel();
fetchCommodities();
</script>
</body>
</html>
